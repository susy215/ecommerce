{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}
{{ block.super }}
<style>
  .pred-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 20px; 
    margin: 20px 0;
  }
  .pred-kpis { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 15px; 
    margin-bottom: 20px;
  }
  .pred-kpi { 
    background: var(--body-bg); 
    border: 1px solid var(--hairline-color);
    padding: 15px; 
    border-radius: 4px;
    border-left: 4px solid var(--link-fg);
  }
  .pred-kpi h4 { 
    margin: 0 0 8px 0; 
    font-weight: 600; 
    font-size: 11px; 
    text-transform: uppercase;
    color: var(--body-quiet-color);
    letter-spacing: 0.5px;
  }
  .pred-kpi .val { 
    font-size: 24px; 
    font-weight: 700;
    color: var(--body-fg);
  }
  .pred-toolbar { 
    display: flex; 
    gap: 15px; 
    align-items: flex-end; 
    margin-bottom: 20px;
    flex-wrap: wrap;
    padding: 15px;
    background: var(--body-bg);
    border: 1px solid var(--hairline-color);
    border-radius: 4px;
  }
  .pred-toolbar .form-row {
    margin: 0;
    flex: 0 0 auto;
  }
  .pred-toolbar .form-row label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 12px;
  }
  .pred-toolbar input[type="number"] {
    width: 80px;
  }
  @media (max-width: 1024px) { 
    .pred-grid { grid-template-columns: 1fr; } 
    .pred-kpis { grid-template-columns: 1fr; } 
  }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Inicio</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label='ia' %}">IA</a>
  &rsaquo; Predicción de Ventas
</div>
{% endblock %}

{% block content %}
<div id="content-main">
  
  <div class="module">
    <h2>Predicción de Ventas - Configuración</h2>
    <div style="padding: 15px;">
      <p class="help">
        Ajusta los parámetros para generar la predicción de ventas basada en el histórico.
        <strong>Nota:</strong> Esta vista usa media móvil simple. Para usar el modelo RandomForestRegressor, accede al endpoint API <code>/api/ia/dashboard/</code>.
      </p>
      
      <form method="get" class="pred-toolbar">
        <div class="form-row">
          <label for="id_dias_hist">Días histórico:</label>
          <input type="number" name="dias_hist" id="id_dias_hist" value="{{ dias_hist }}" min="7" max="365" class="vIntegerField"/>
        </div>
        <div class="form-row">
          <label for="id_dias_forecast">Días a predecir:</label>
          <input type="number" name="dias_forecast" id="id_dias_forecast" value="{{ dias_forecast }}" min="1" max="60" class="vIntegerField"/>
        </div>
        <div class="form-row">
          <label for="id_ventana">Ventana (media móvil):</label>
          <input type="number" name="ventana" id="id_ventana" value="{{ ventana }}" min="1" max="30" class="vIntegerField"/>
        </div>
        <div class="form-row">
          <input type="submit" value="Actualizar" class="default" />
        </div>
        <div class="form-row">
          <input type="submit" name="download" value="Descargar CSV" class="button" />
        </div>
      </form>
    </div>
  </div>

  <div class="module">
    <h2>KPIs - Histórico</h2>
    <div style="padding: 15px;">
      <div class="pred-kpis">
        <div class="pred-kpi">
          <h4>Total histórico</h4>
          <div class="val">{{ historico_total }}</div>
        </div>
        <div class="pred-kpi">
          <h4>Promedio histórico</h4>
          <div class="val">{{ historico_promedio }}</div>
        </div>
        <div class="pred-kpi">
          <h4>Último día</h4>
          <div class="val">{{ historico_ultimo_dia }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="module">
    <h2>KPIs - Pronóstico</h2>
    <div style="padding: 15px;">
      <div class="pred-kpis">
        <div class="pred-kpi">
          <h4>Total pronóstico</h4>
          <div class="val">{{ forecast_total }}</div>
        </div>
        <div class="pred-kpi">
          <h4>Promedio pronóstico</h4>
          <div class="val">{{ forecast_promedio }}</div>
        </div>
        <div class="pred-kpi">
          <h4>Horizonte (días)</h4>
          <div class="val">{{ dias_forecast }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="pred-grid">
    <div class="module">
      <h2>Histórico</h2>
      <div style="overflow-x: auto;">
        <table id="result_list">
          <thead>
            <tr>
              <th scope="col">Fecha</th>
              <th scope="col">Total</th>
            </tr>
          </thead>
          <tbody>
          {% for p in historico %}
            <tr class="{% cycle 'row1' 'row2' %}">
              <td>{{ p.fecha }}</td>
              <td>{{ p.total }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="module">
      <h2>Pronóstico</h2>
      <div style="overflow-x: auto;">
        <table id="result_list">
          <thead>
            <tr>
              <th scope="col">Fecha</th>
              <th scope="col">Total (estimado)</th>
            </tr>
          </thead>
          <tbody>
          {% for f in forecast %}
            <tr class="{% cycle 'row1' 'row2' %}">
              <td>{{ f.fecha }}</td>
              <td>{{ f.total }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
