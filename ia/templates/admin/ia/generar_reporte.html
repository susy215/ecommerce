{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .ejemplo-item {
        padding: 10px 12px;
        margin: 5px 0;
        border-left: 3px solid var(--link-fg);
        background: var(--body-bg);
        border-radius: 2px;
        transition: background-color 0.15s ease;
    }
    .ejemplo-item:hover {
        background: var(--darkened-bg);
        cursor: pointer;
    }
    .historial-table {
        width: 100%;
    }
    .historial-row {
        border-bottom: 1px solid var(--hairline-color);
        transition: background-color 0.15s ease;
    }
    .historial-row:hover {
        background: var(--darkened-bg);
        cursor: pointer;
    }
    .historial-row td {
        padding: 12px;
        vertical-align: top;
    }
    .ejemplo-list {
        padding: 0 15px 15px 15px;
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Inicio</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='ia' %}">IA</a>
    &rsaquo; Generar Reporte con IA
</div>
{% endblock %}

{% block content %}
<div id="content-main">
    
    {% if error %}
    <div class="messagelist">
        <div class="error">{{ error }}</div>
    </div>
    {% endif %}
    
    <div class="module">
        <h2>Generar Reporte con IA</h2>
        
        <div style="padding: 15px;">
            <p class="help">
                <strong>ðŸ’¡ Consejos para mejores resultados:</strong><br>
                â€¢ Especifica el <strong>tipo de reporte</strong>: ventas, productos, clientes, inventario<br>
                â€¢ Incluye <strong>fechas</strong>: "septiembre", "Ãºltima semana", "01/10/2024"<br>
                â€¢ Indica el <strong>formato</strong>: PDF, Excel, CSV, o "en pantalla"<br>
                â€¢ Usa <strong>lÃ­mites</strong>: "top 10", "primeros 20"<br>
                â€¢ Agrupa datos: "agrupado por producto", "por cliente"
            </p>
            
            <form method="post">
                {% csrf_token %}
                <div class="form-row">
                    <div>
                        <label for="prompt" class="required">Tu consulta:</label>
                        <textarea 
                            name="prompt" 
                            id="prompt" 
                            rows="4" 
                            style="width: 100%;" 
                            class="vLargeTextField"
                            placeholder="Ej: Quiero un reporte de ventas del mes de septiembre, agrupado por producto, en PDF"
                            required
                        >{{ prompt }}</textarea>
                        <p class="help">Escribe tu pregunta como si le hablaras a una persona.</p>
                    </div>
                </div>
                <div class="submit-row">
                    <input type="submit" value="Generar Reporte" class="default">
                </div>
            </form>
        </div>
    </div>
    
    <div class="module">
        <h2>Ejemplos de consultas</h2>
        <p style="padding: 10px 15px;" class="help">Haz clic en cualquier ejemplo para usarlo:</p>
        <div class="ejemplo-list">
            {% for ejemplo in ejemplos %}
            <div class="ejemplo-item" data-ejemplo="{{ ejemplo|escape }}">
                {{ ejemplo }}
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% if historial %}
    <div class="module">
        <h2>Historial Reciente</h2>
        <table class="historial-table">
            <thead>
                <tr>
                    <th scope="col" style="width: 70%;">Consulta</th>
                    <th scope="col" style="text-align: right;">Estado</th>
                </tr>
            </thead>
            <tbody>
            {% for consulta in historial %}
            <tr class="historial-row" data-prompt="{{ consulta.prompt|escape }}">
                <td>
                    <strong>{{ consulta.prompt|truncatewords:20 }}</strong>
                    <div class="quiet" style="font-size: 11px; margin-top: 5px;">
                        {{ consulta.fecha_consulta|date:"d/m/Y H:i" }}
                        {% if consulta.tiempo_ejecucion %}
                        - {{ consulta.tiempo_ejecucion|floatformat:2 }}s
                        {% endif %}
                    </div>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                    {% if consulta.error %}
                    <span style="color: var(--error-fg); font-weight: 600;">âœ— Error</span>
                    {% else %}
                    <span style="color: var(--success-fg); font-weight: 600;">âœ“ Exitoso</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
</div>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
(function() {
    'use strict';
    
    // Esperar a que el DOM estÃ© completamente cargado
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', inicializarEventos);
    } else {
        inicializarEventos();
    }
    
    function inicializarEventos() {
        console.log('Inicializando eventos de reportes IA');
        
        // Ejemplos de consultas
        var ejemplos = document.querySelectorAll('.ejemplo-item');
        console.log('Ejemplos encontrados:', ejemplos.length);
        
        ejemplos.forEach(function(item) {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                var ejemplo = this.getAttribute('data-ejemplo');
                var promptField = document.getElementById('prompt');
                
                console.log('Ejemplo clickeado:', ejemplo);
                console.log('Campo prompt encontrado:', !!promptField);
                
                if (promptField && ejemplo) {
                    promptField.value = ejemplo;
                    promptField.focus();
                    // Scroll suave al formulario
                    promptField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    console.error('No se pudo cargar el ejemplo');
                }
            });
        });
        
        // Historial
        var historialRows = document.querySelectorAll('.historial-row');
        console.log('Filas de historial encontradas:', historialRows.length);
        
        historialRows.forEach(function(row) {
            row.addEventListener('click', function(e) {
                e.preventDefault();
                var prompt = this.getAttribute('data-prompt');
                var promptField = document.getElementById('prompt');
                
                console.log('Historial clickeado:', prompt);
                
                if (promptField && prompt) {
                    promptField.value = prompt;
                    promptField.focus();
                    // Scroll suave al formulario
                    promptField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        });
    }
})();
</script>
{% endblock %}
